/*! talkable-integration v4.1.0 | (c) Talkable | talkable.com */
Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement){if(void 0===this||null===this)throw TypeError();var t=Object(this),len=t.length>>>0;if(0===len)return-1;var n=0;if(arguments.length>0&&(n=Number(arguments[1]),isNaN(n)?n=0:0!==n&&n!==1/0&&n!==-(1/0)&&(n=(n>0||-1)*Math.floor(Math.abs(n)))),n>=len)return-1;for(var k=n>=0?n:Math.max(len-Math.abs(n),0);len>k;k++)if(k in t&&t[k]===searchElement)return k;return-1}),"remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)}),Array.isArray||(Array.isArray=function(arg){return"[object Array]"===Object.prototype.toString.call(arg)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),window.btoa||(window.btoa=function(input){for(var block,charCode,chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",str=String(input),idx=0,map=chars,output="";str.charAt(0|idx)||(map="=",idx%1);output+=map.charAt(63&block>>8-idx%1*8))charCode=str.charCodeAt(idx+=.75),charCode>255&&window.console&&window.console.error&&console.error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range."),block=block<<8|charCode;return output}),Array.isArray||(Array.isArray=function(arg){return"[object Array]"===Object.prototype.toString.call(arg)}),Object.isObject||(Object.isObject=function(arg){return"[object Object]"===Object.prototype.toString.call(arg)}),function(window,document,JSON,Object){var talkable=window.talkable=function(){var customerData={},UUID_KEY="tkbl_cvuuid",config={testing:!1,debug:!1,verify_integration:!1,site_id:"",server:"https://www.talkable.com",version:"4.1.0",queue_check_interval:200,async:!1,url_length_limit:2e3,current_location:window.location.href,timeout:15},utils={lastLoadedIframeName:[],gleamRewardCallback:void 0,log:function(message,source){"undefined"!=typeof window.console&&config.debug&&(source=source||"all-"+config.version,console.log(source+" >> "+message))},serialize:function(object,prefix){var i,key;if(!object)return"";if(!prefix&&!Object.isObject(object))throw new Error("Url parameters should be a javascript hash");var s=[];if(Array.isArray(object))for(i=0,object.length;i<object.length;++i)s.push(this.serialize(object[i],prefix+"[]"));else if(Object.isObject(object)){for(key in object)if(this.hasProperty(object,key)){var prop=object[key];if(null!=prop){0===prop&&(prop=prop.toString()),null!=prefix&&(key=""+prefix+"["+key+"]");var fragment=this.serialize(prop,key);fragment&&s.push(this.serialize(prop,key))}}}else object&&s.push(""+encodeURIComponent(prefix.toString())+"="+encodeURIComponent(object.toString()));return s.length?s.join("&"):""},merge:function(target,src){if("object"==typeof target){var dst={};for(var key in target)dst[key]=target[key];for(var key in src)"object"==typeof src[key]&&src[key]&&target[key]?dst[key]=utils.merge(target[key],src[key]):dst[key]=src[key];return dst}},clone:function(object){return utils.merge(object,{})},postmessage:{send:function(json,target,targetElement){if("undefined"==typeof target)throw new Error("You must supply a target as a string");"undefined"==typeof targetElement&&(targetElement=window.parent),targetElement.postMessage(JSON.stringify(json),target)},listen:function(callback){var receiveMessage=function(message){try{var o=JSON.parse(message.data);o&&"object"==typeof o&&null!==o&&callback(o)}catch(ex){}};window.addEventListener?window.addEventListener("message",receiveMessage,!1):window.attachEvent("onmessage",receiveMessage)}},subscribe:function(name,iframe_name,callback){utils.postmessage.listen(function(message){if(message&&message.type==name&&callback){var container=document.getElementById(iframe_name);if(container&&(iframe_name=container.getElementsByTagName("iframe").length&&container.getElementsByTagName("iframe")[0].name),!message.iframe_name||iframe_name!=message.iframe_name)return;var iframe=document.querySelector("iframe[name='"+message.iframe_name+"']");if(!iframe)return;callback(message.data,iframe)}})},publish:function(name,iframe_name,data,is_global){var server=config.server,msg_data={type:name,iframe_name:iframe_name,data:data||{}};"undefined"!=typeof is_global&&is_global&&(server="*"),-1!==utils.lastLoadedIframeName.indexOf(iframe_name)&&window.frames[iframe_name]?utils.postmessage.send(msg_data,server,window.frames[iframe_name]):this.subscribe("offer_loaded",iframe_name,function(data,iframe_data){iframe_data.name==iframe_name&&utils.postmessage.send(msg_data,server,window.frames[iframe_name])})},notifyIntegrationError:function(message,dev){utils.addImage(utils.namespace(window.talkable.config.server,window.talkable.config.site_id)+"/notify_integration_error.gif?"+utils.serialize({message:message,dev:dev}))},isBrowserSupported:function(){return!(window.navigator.userAgent.indexOf("MSIE 6.0")>-1||window.navigator.userAgent.indexOf("MSIE 7.0")>-1)},getIframeCreationExtension:function(){return this.isBrowserSupported()?"html":"gif"},documentAppend:function(node){document.body.appendChild(node)},isGenerated:function(el){return"true"==el.getAttribute("data-talkable-generated")},hasProperty:function(options,key){return options.hasOwnProperty(key)},setAttributes:function(element,attrs){for(var key in attrs)element.setAttribute(key,attrs[key])},location_parameters:function(){for(var vars={},current_location=config.current_location.split("#")[0],hashes=current_location.slice(current_location.indexOf("?")+1).split("&"),i=0;i<hashes.length;i++){var hash=hashes[i].split("=");"undefined"!=typeof hash[1]&&(vars[hash[0]]=decodeURIComponent(hash[1]))}return vars},location_parameter:function(name){return this.location_parameters()[name]},callbacks:{},before:function(method_name,callback){utils.callbacks[method_name]=callback},matches:function(matcher){if(matcher.blank)return!0;if(matcher.regexp)return window.location.href.match(RegExp(matcher.regexp));if(matcher.host_pattern&&matcher.host_pattern!==window.location.hostname)return!1;for(var name in matcher.query_pattern)if(-1==window.location.search.indexOf(name+"="+matcher.query_pattern[name]))return!1;if(matcher.path_pattern){if(talkablePlacementsConfig.site_url){var site_url=document.createElement("a");site_url.href=talkablePlacementsConfig.site_url+matcher.path_pattern,matcher.path_pattern=site_url.pathname.replace(/(^\/*)/g,"/")}if(matcher.path_pattern!==window.location.pathname)return!1}return!0},match_placements:function(){for(var matched=[],i=0;i<talkablePlacementsConfig.placements.length;i++){for(var placement=talkablePlacementsConfig.placements[i],exclusion_matched=!1,k=0;k<placement.exclusion_matchers.length&&!exclusion_matched;k++)exclusion_matched=this.matches(placement.exclusion_matchers[k]);if(!exclusion_matched)for(var matchers=placement.inclusion_matchers||[placement.inclusion_matcher],j=0;j<matchers.length;j++)if(this.matches(matchers[j])){matched.push(placement.id);break}}return matched.length?matched:["0"]},ensureInitialized:function(){if(!window.talkable.initialized)throw new Error("You need to call 'init' first")},namespace:function(server,site_id){return(server||config.server)+"/public/"+encodeURIComponent(site_id||config.site_id)},addImage:function(url){utils.log("addImage: "+url),document.images&&((new Image).src=url)},defaultIframeOptions:function(name){return name=name||"talkable-offer",{container:name,name:name+"-iframe"}},insertIframeIntoContainer:function(iframe,containerId){var containerEl=document.getElementById(containerId.replace("#",""));containerEl?(containerEl.innerHTML="",containerEl.appendChild(iframe)):this.domReady(function(){containerEl=document.getElementById(containerId.replace("#","")),containerEl?containerEl.innerHTML="":(containerEl=document.createElement("div"),containerEl.setAttribute("data-talkable-generated",!0),containerEl.setAttribute("id",containerId),document.body.appendChild(containerEl)),containerEl.appendChild(iframe)})},setIntegrationCss:function(data){if(data&&data.css){styleTag=document.createElement("style"),styleTag.id=data.attribute_value,styleTag.dataset.talkableIntegrationCss=!0,styleTag.type="text/css",styleTag.styleSheet?styleTag.styleSheet.cssText=data.css:styleTag.appendChild(document.createTextNode(data.css));var styleTagNode=document.getElementById(data.attribute_value);styleTagNode&&styleTagNode.remove(),document.body&&document.body.appendChild(styleTag)}},addIframeElement:function(url,options){utils.log("addIframeElement: "+url),options=utils.clone(options||{}),options.frameBorder="0",options.allowTransparency=!0,options.src=url;var container=options.container||utils.generateRandomIframeName();delete options.container,utils.addRandomIframeName(options);var iframe=null,styleTag=null;return iframe=document.createElement("iframe"),iframe.style.display="none",iframe.style.opacity="0",this.setAttributes(iframe,options),this.insertIframeIntoContainer(iframe,container),utils.subscribe("responsive_iframe_height",iframe.name,function(data,iframe){iframe.style.height=data.height+"px"}),utils.subscribe("change_offer_state",iframe.name,function(data,iframe){"inline"===data.campaign_appearance&&iframe.parentNode&&utils.isGenerated(iframe.parentNode)||data&&data.offer_state&&data.offer_state_attribute&&(data.width&&(iframe.style.width=data.width),data.height&&(iframe.style.height=data.height),data.integration_css&&utils.setIntegrationCss(data.integration_css),currentAttribute=document.body.getAttribute(data.offer_state_attribute)||"","add"==data.action&&-1==currentAttribute.indexOf(data.offer_state)?document.body.setAttribute(data.offer_state_attribute,(data.offer_state+" "+currentAttribute).trim()):"remove"==data.action?document.body.setAttribute(data.offer_state_attribute,currentAttribute.replace(data.offer_state,"").trim()):"set"==data.action&&document.body.setAttribute(data.offer_state_attribute,data.offer_state),setTimeout(function(){document.all&&!window.atob&&(document.body.className=document.body.className)},0))}),utils.subscribe("set_location",iframe.name,function(data){data&&data.href&&-1==data.href.indexOf("javascript:")&&(window.location.href=data.href)}),utils.subscribe("scroll_to",iframe.name,function(data,iframe){if(data.selector){var matches=document.querySelectorAll(data.selector);matches.length>0&&(data.y=matches[0].offsetTop)}window.scrollTo(data.x,data.y||iframe.offsetTop)}),utils.subscribe("offer_close",iframe.name,function(data,iframe){var index=utils.lastLoadedIframeName.indexOf(iframe.name);-1!=index&&utils.lastLoadedIframeName.splice(index,1),iframe.parentNode.removeChild(iframe),styleTag&&styleTag.parentNode.removeChild(styleTag),iframe=null,styleTag=null}),utils.subscribe("offer_loaded",iframe.name,function(data){if(utils.lastLoadedIframeName.push(iframe.name),data.current_visitor_uuid?utils.setUUID(data.current_visitor_uuid):utils.deleteUUID(),data.perform_snapshot&&utils.scrapeDOM(),utils.gleamRewardCallback&&data.gleam_reward)try{utils.gleamRewardCallback(data.gleam_reward)}catch(ex){utils.log(ex)}"inline"===data.campaign_appearance&&iframe.parentNode&&utils.isGenerated(iframe.parentNode)||(data.integration_css||data.integration_css.css)&&(styleTag=document.createElement("style"),styleTag.id=data.integration_css.attribute_value,styleTag.dataset.talkableIntegrationCss=!0,styleTag.type="text/css",styleTag.styleSheet?styleTag.styleSheet.cssText=data.integration_css.css:styleTag.appendChild(document.createTextNode(data.integration_css.css)),document.getElementById(data.integration_css.attribute_value)||document.body&&document.body.appendChild(styleTag),data.integration_css.attribute_name&&data.integration_css.attribute_value&&iframe.setAttribute(data.integration_css.attribute_name,data.integration_css.attribute_value))}),iframe},buildJs:function(url){var result=document.createElement("script");return result.type="text/javascript",result.async=config.async,result.src=url,result},addJs:function(url){utils.log("addJs: "+url);var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(utils.buildJs(url),s)},createUrl:function(path,parameters){var create_url=utils.namespace()+path,items=null;if(parameters=utils.merge({v:config.version},parameters),parameters.o&&parameters.o.i&&(items=parameters.o.i,delete parameters.o.i),create_url=create_url+"?"+utils.serialize(parameters),items)for(var i=0;i<items.length;i++){var item=items[i],itemsParams="&"+utils.serialize({product_id:item.product_id,price:item.price,quantity:item.quantity},"o[i]["+i+"]");(create_url+itemsParams).length<config.url_length_limit&&(create_url+=itemsParams)}return create_url},formIframe:function(options,url_path,url_parameters){if(options.iframe.container&&options.iframe.container==options.trigger_widget.container)throw new Error("`trigger_widget` container should be different from `iframe` container.");this.fetchInternalIPIfNeeded(!options.iframe.container,function(internal_ip){url_path=url_path+"."+utils.getIframeCreationExtension(),internal_ip&&url_parameters.o&&(url_parameters.o.internal_ip_address=internal_ip),url_parameters.o&&url_parameters.o.email&&(url_parameters.o.email=btoa(url_parameters.o.email)),utils.getUUID()&&(url_parameters.cvuuid=utils.getUUID());var create_url=utils.createUrl(url_path,url_parameters);utils.showOffer(utils.merge(options,{url:create_url}))})},showOffer:function(options){if(utils.isBrowserSupported()){var iframe_options=utils.merge(utils.defaultIframeOptions(),options.iframe),popupName=iframe_options.name+"-popup",triggered_iframe_options={container:popupName,name:popupName};options.trigger_widget&&options.trigger_widget.container&&(iframe_options=utils.merge(utils.defaultIframeOptions(),options.trigger_widget),triggered_iframe_options=utils.merge(triggered_iframe_options,options.iframe));var iframe=utils.addIframeElement(options.url,iframe_options);utils.subscribe("offer_triggered",iframe.name,function(data){utils.addIframeElement(config.server+data.offer_share_path,triggered_iframe_options)})}else utils.addImage(options.url)},cleanupRegisterData:function(data){delete data.campaign_tags,delete data.device,delete data.iframe,delete data.campaign_template,delete data.trigger_widget,delete data.tkbl_expand,delete data.custom_properties},extractOriginData:function(data,key){var result;return this.hasProperty(data,key)?(result=utils.merge(data.customer||{},data[key]),delete data.customer):result=data,result},doubleIntegrationCheck:function(){var another_integration=window.curebit||window.talkable;another_integration&&parseInt(config.version)!=parseInt(another_integration.version)&&utils.notifyIntegrationError("Another integration.js with version "+another_integration.config.version+" conflicts with current "+config.version+" on "+window.location.href)},internalIP:null,fetchInternalIPIfNeeded:function(skip_async,callback){return void(callback&&callback(null))},generateRandomIframeName:function(){return"talkable_integration_"+Math.random().toString(36).substring(2)},addRandomIframeName:function(params){var name=this.generateRandomIframeName();return params&&!params.name&&(params.name=name),name},scrapeDOM:function(){var iframeName=utils.lastLoadedIframeName[utils.lastLoadedIframeName.length-1];if(document.documentElement){var doctypeNode=document.doctype,doctypeString="<!DOCTYPE "+doctypeNode.name+(doctypeNode.publicId?' PUBLIC "'+doctypeNode.publicId+'"':"")+(!doctypeNode.publicId&&doctypeNode.systemId?" SYSTEM":"")+(doctypeNode.systemId?' "'+doctypeNode.systemId+'"':"")+">",domString=doctypeString;domString+="<html>",domString+=document.documentElement.innerHTML,domString+="</html>",this.publish("dom_capture",iframeName,{dom:domString,url:document.location.href})}},domReady:function(callback){var ready=!1,detach=function(){document.addEventListener?(document.removeEventListener("DOMContentLoaded",completed),window.removeEventListener("load",completed)):(document.detachEvent("onreadystatechange",completed),window.detachEvent("onload",completed))},completed=function(){ready||!document.addEventListener&&"load"!==event.type&&"complete"!==document.readyState||(ready=!0,detach(),callback())};if("complete"===document.readyState)callback();else if(document.addEventListener)document.addEventListener("DOMContentLoaded",completed),window.addEventListener("load",completed);else{document.attachEvent("onreadystatechange",completed),window.attachEvent("onload",completed);var top=!1;try{top=null==window.frameElement&&document.documentElement}catch(e){}top&&top.doScroll&&!function scrollCheck(){if(!ready){try{top.doScroll("left")}catch(e){return setTimeout(scrollCheck,50)}ready=!0,detach(),callback()}}()}},getCookie:function(name){var query="(^|; )"+name+"=([^;]*)";return(document.cookie.match(query)||[]).pop()},setCookie:function(name,value){if(name&&value){var date=new Date;date.setTime(date.getTime()+63072e7),document.cookie=name+"="+value+"; expires="+date.toGMTString()+"; path=/"}},deleteCookie:function(name){document.cookie=name+"=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;"},getUUID:function(){return this.getCookie(UUID_KEY)},setUUID:function(current_visitor_uuid){this.setCookie(UUID_KEY,current_visitor_uuid)},deleteUUID:function(){this.deleteCookie(UUID_KEY)}};utils.doubleIntegrationCheck();var methods={init:function(options){for(var key in options)utils.hasProperty(options,key)&&(config[key]=options[key]);if(!config.site_id)throw new Error("site_id must be specified!");talkable.initialized=!0},authenticate_customer:function(data){var registerData=utils.clone(data||{}),customer=registerData.customer?utils.clone(registerData.customer):registerData;Object.isObject(customer)&&(customerData=customer)},register_affiliate:function(data){utils.ensureInitialized();for(var registerData=utils.clone(data||{}),affiliate_member=registerData.customer||registerData.affiliate_member||{},options={iframe:registerData.iframe||{},trigger_widget:registerData.trigger_widget||{}},verify_integration=utils.location_parameter("tkbl_verify_integration")||config.verify_integration,url_parameters=["email","first_name","last_name","traffic_source"],i=0;i<url_parameters.length;i++){var parameter=url_parameters[i];utils.location_parameter(parameter)&&(affiliate_member[parameter]=utils.location_parameter(parameter))}var parameters={o:utils.merge(customerData,affiliate_member),campaign_tags:utils.location_parameter("campaign_tags")||registerData.campaign_tags,affiliate_campaign_id:utils.location_parameter("tkbl_campaign_id"),custom_properties:registerData.custom_properties,tkbl_expand:utils.location_parameter("tkbl_expand")||registerData.expand_trigger_widget,matched_placement_ids:utils.match_placements(),ts:talkablePlacementsConfig.timestamp,ii:talkablePlacementsConfig.integration_id,vi:verify_integration};utils.formIframe(options,"/affiliate_members/create",parameters)},register_purchase:function(data){utils.ensureInitialized();var registerData=utils.clone(data||{}),purchase=utils.extractOriginData(registerData,"purchase");purchase.customer_email&&(purchase.email=purchase.customer_email,delete purchase.customer_email);var items=purchase.items;delete purchase.items;var options={iframe:registerData.iframe||{},trigger_widget:registerData.trigger_widget||{}},campaign_tags=utils.location_parameter("campaign_tags")||registerData.campaign_tags,custom_properties=registerData.custom_properties,verify_integration=(registerData.verification_digest,utils.location_parameter("tkbl_verify_integration")||config.verify_integration);utils.cleanupRegisterData(registerData);var parameters={o:utils.merge(customerData,purchase),campaign_tags:campaign_tags,affiliate_campaign_id:utils.location_parameter("tkbl_campaign_id"),custom_properties:custom_properties,matched_placement_ids:utils.match_placements(),ts:talkablePlacementsConfig.timestamp,ii:talkablePlacementsConfig.integration_id,vi:verify_integration};if(items){parameters.o.i=[];for(var i=0;i<items.length;i++){var item=items[i];parameters.o.i.push({product_id:item.product_id,price:item.price,quantity:item.quantity}),(item.url||item.image_url||item.title)&&methods._register_products([{product_id:item.product_id,url:item.url,image_url:item.image_url,title:item.title,price:item.price}])}}utils.formIframe(options,"/purchases/create",parameters)},register_event:function(data){utils.ensureInitialized();var registerData=utils.clone(data||{}),options={iframe:registerData.iframe||{},trigger_widget:registerData.trigger_widget||{}},campaign_tags=utils.location_parameter("campaign_tags")||registerData.campaign_tags,custom_properties=registerData.custom_properties,verify_integration=utils.location_parameter("tkbl_verify_integration")||config.verify_integration;utils.cleanupRegisterData(registerData);var event=utils.extractOriginData(registerData,"event"),parameters={o:utils.merge(customerData,event),campaign_tags:campaign_tags,affiliate_campaign_id:utils.location_parameter("tkbl_campaign_id"),custom_properties:custom_properties,matched_placement_ids:utils.match_placements(),ts:talkablePlacementsConfig.timestamp,ii:talkablePlacementsConfig.integration_id,vi:verify_integration};utils.formIframe(options,"/events/create",parameters)},show_offer:function(options){utils.showOffer(options)},gleam_reward:function(data){utils.gleamRewardCallback=data.callback},_register_products:function(products){utils.ensureInitialized();for(var i=0;i<products.length;i++)utils.addImage(utils.createUrl("/products/create.gif",{p:products[i]}))}};return{initialized:!1,config:config,before:utils.before,methods:methods,domReady:utils.domReady,subscribe:utils.subscribe,publish:utils.publish,scrapeDOM:utils.scrapeDOM,check:function(){if("undefined"!=typeof _talkableq&&Array.isArray(_talkableq))for(;_talkableq.length>0;){var action=_talkableq.shift(),method=action[0],params=action[1];utils.callbacks[method]&&(params=utils.callbacks[method].call(talkable,params)),params&&methods[method].call(talkable,params)}},run:function(){talkable.check(),talkable._timer=setInterval(talkable.check,config.queue_check_interval)},_timer:null}}();talkable.run()}(window,document,JSON,Object);
//# sourceMappingURL=talkable.min.map